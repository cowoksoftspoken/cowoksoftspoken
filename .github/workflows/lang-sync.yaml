name: Sync GitHub Language Stats

on:
  schedule:
    - cron: "0 0 * * 1"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-languages:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Aggregate languages from all repos
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python << 'EOF'
          import requests
          import os
          from collections import defaultdict

          token = os.environ["GITHUB_TOKEN"]
          user = "${{ github.repository_owner }}"

          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json"
          }

          repos = []
          page = 1
          while True:
              r = requests.get(
                  f"https://api.github.com/users/{user}/repos",
                  headers=headers,
                  params={"per_page": 100, "page": page}
              )
              data = r.json()
              if not data:
                  break
              repos.extend(data)
              page += 1

          langs = defaultdict(int)

          for repo in repos:
              if repo.get("fork"):
                  continue

              lang_url = repo.get("languages_url")
              if not lang_url:
                  continue

              r = requests.get(lang_url, headers=headers)
              if r.status_code != 200:
                  continue

              data = r.json()
              for lang, size in data.items():
                  langs[lang] += size

          if not langs:
              print("No language data found.")
              exit(0)

          total = sum(langs.values())

          lines = ["```txt"]
          for lang, size in sorted(langs.items(), key=lambda x: x[1], reverse=True):
              pct = size / total * 100
              bar = "â–ˆ" * int(pct // 2)
              lines.append(f"{lang:<12} {bar:<25} {pct:5.2f} %")
          lines.append("```")

          content = "\n".join(lines)
          
          with open("README.md", "r", encoding="utf-8") as f:
              readme = f.read()

          start = "<!-- LANG-STATS:START -->"
          end = "<!-- LANG-STATS:END -->"

          if start not in readme or end not in readme:
              raise RuntimeError("LANG-STATS markers not found in README.md")

          new_readme = (
              readme.split(start)[0]
              + start + "\n"
              + content + "\n"
              + end
              + readme.split(end)[1]
          )

          with open("README.md", "w", encoding="utf-8") as f:
              f.write(new_readme)

          print("README updated successfully.")
          EOF

      - name: Commit changes
        uses: EndBug/add-and-commit@v9
        with:
          message: "chore: sync GitHub language stats"
          add: "README.md"
