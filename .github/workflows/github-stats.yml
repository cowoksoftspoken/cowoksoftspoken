name: Update GitHub Stats (Waka style)

on:
  schedule:
    - cron: "0 0 * * 1"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  github-stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate Top 5 Languages in Waka style
        run: |
          LANGS=$(curl -s https://api.github.com/repos/cowoksoftspoken/cowoksoftspoken/languages | jq -r 'to_entries|sort_by(.value)|reverse|.[0:5]|.[] | "\(.key) \(.value)"')
          TOTAL=$(echo "$LANGS" | awk '{sum += $2} END {print sum}')
          echo "<!--START_SECTION:github-stats-->" > tmp.md
          while read -r line; do
            LANG=$(echo $line | awk '{print $1}')
            VAL=$(echo $line | awk '{print $2}')
            PCT=$(awk "BEGIN{printf \"%.2f\", ($VAL/$TOTAL)*100}")
            BAR=$(awk "BEGIN{bars=int($PCT/2); for(i=0;i<bars;i++) printf \"â–ˆ\"; print \"\"}")
            printf "%-12s %s %6s %%\n" "$LANG" "$BAR" "$PCT" >> tmp.md
          done <<< "$LANGS"
          echo "<!--END_SECTION:github-stats-->" >> tmp.md

          awk 'BEGIN{found=0} /<!--START_SECTION:github-stats-->/ {found=1; print; next} /<!--END_SECTION:github-stats-->/ {found=0; print; next} !found {print}' README.md >> tmp.md
          mv tmp.md README.md

      - name: Commit updated stats
        uses: EndBug/add-and-commit@v9
        with:
          message: "chore: update GitHub stats"
          add: "README.md"
